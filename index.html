<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Tahfizh Al-Quran</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a4d3a 0%, #2d5016 50%, #0f2027 100%);
            color: #333;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #1a4d3a;
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: #666;
            font-size: 1em;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            margin-bottom: 15px;
            padding: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 5px;
        }

        .tab {
            flex: 1;
            padding: 12px 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #666;
            font-size: 14px;
            min-width: 120px;
        }

        .tab.active {
            background: linear-gradient(135deg, #2d5016 0%, #1a4d3a 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(45, 80, 22, 0.3);
        }

        .tab:hover:not(.active) {
            background: rgba(45, 80, 22, 0.1);
        }

        .tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a4d3a;
            font-size: 14px;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2d5016;
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-row-triple {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .status-option.active {
            border-color: #2d5016;
            background: rgba(45, 80, 22, 0.1);
        }

        .status-option:hover {
            border-color: #2d5016;
        }

        .status-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .ziyadah-fields, .ujian-fields {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2d5016;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2d5016 0%, #1a4d3a 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(45, 80, 22, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
            width: auto;
            margin: 0 5px 0 0;
        }

        .leaderboard {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-header {
            background: linear-gradient(135deg, #1a4d3a 0%, #2d5016 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            background: rgba(45, 80, 22, 0.1);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 20px;
            width: 50px;
            text-align: center;
            color: #1a4d3a;
        }

        .participant-info {
            flex: 1;
        }

        .participant-name {
            font-weight: 600;
            color: #1a4d3a;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .level-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .level-1 { background: #e8f5e8; color: #2d5016; }
        .level-2 { background: #d4edda; color: #1a4d3a; }
        .level-3 { background: #c3e6cb; color: #155724; }
        .level-4 { background: #b3d9c5; color: #0f3b21; }
        .level-5 { background: #a3ccbf; color: #0a2b1a; }
        .level-6 { background: #93bfb9; color: #051b14; }
        .level-7 { background: linear-gradient(45deg, #2d5016, #1a4d3a); color: #fff; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2d5016 0%, #1a4d3a 100%);
            transition: width 0.3s ease;
        }

        .stats {
            text-align: right;
            color: #666;
            font-size: 0.9em;
        }

        .hafalan-count {
            font-size: 1.2em;
            font-weight: bold;
            color: #1a4d3a;
        }

        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #2d5016;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #1a4d3a;
            font-size: 1.5em;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            padding: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .login-form {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .current-user {
            background: rgba(45, 80, 22, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1a4d3a;
            text-align: center;
        }

        .filter-selector {
            background: rgba(45, 80, 22, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-items: end;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #2d5016;
        }

        .summary-number {
            font-size: 2em;
            font-weight: bold;
            color: #1a4d3a;
        }

        .summary-label {
            color: #666;
            font-size: 0.9em;
        }

        .attendance-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .attendance-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .attendance-table th,
        .attendance-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .attendance-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #1a4d3a;
        }

        .attendance-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-ziyadah {
            background: #d4edda;
            color: #155724;
        }

        .status-ujian {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-sakit {
            background: #f8d7da;
            color: #721c24;
        }

        .status-berhalangan {
            background: #fff3cd;
            color: #856404;
        }

        /* Loading state */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error states */
        .error-border {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2) !important;
        }

        .success-border {
            border-color: #28a745 !important;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2) !important;
        }

        .level-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .level-stat-card {
            background: rgba(45, 80, 22, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(45, 80, 22, 0.3);
        }

        .level-stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #1a4d3a;
        }

        .level-stat-label {
            font-size: 0.8em;
            color: #666;
        }

        /* Enhanced Mobile Responsive */
        @media (max-width: 1024px) {
            .container {
                padding: 8px;
            }
            
            .admin-actions {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }

            .filter-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .form-row-triple {
                grid-template-columns: 1fr 1fr;
            }

            .level-stats {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 5px;
            }

            .header {
                padding: 15px 10px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .header p {
                font-size: 0.9em;
            }

            .tabs {
                flex-direction: column;
                gap: 2px;
                padding: 3px;
            }

            .tab {
                margin: 0;
                padding: 12px 8px;
                font-size: 14px;
                min-width: auto;
            }

            .content {
                padding: 15px 10px;
            }

            .form-row, .form-row-triple {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .status-options {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .status-option {
                padding: 12px;
            }

            .admin-actions {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .leaderboard-item {
                padding: 12px 15px;
                flex-wrap: wrap;
            }

            .rank {
                font-size: 1.2em;
                width: 40px;
                margin-right: 15px;
            }

            .participant-info {
                min-width: 200px;
            }

            .hafalan-count {
                font-size: 1em;
                margin-top: 8px;
                width: 100%;
                text-align: left;
            }

            .modal {
                padding: 10px;
            }

            .modal-content {
                padding: 20px 15px;
                margin: 0;
            }

            .btn-group {
                flex-direction: column;
                gap: 8px;
            }

            .btn-group .btn {
                width: 100%;
                margin: 0;
            }

            .attendance-table {
                overflow-x: auto;
            }

            .attendance-table table {
                min-width: 500px;
            }

            .attendance-table th,
            .attendance-table td {
                padding: 8px 6px;
                font-size: 14px;
            }

            .form-group select,
            .form-group input,
            .form-group textarea {
                font-size: 16px;
            }

            .level-stats {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 8px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 3px;
            }

            .header {
                padding: 12px 8px;
            }

            .header h1 {
                font-size: 1.1em;
            }

            .content {
                padding: 12px 8px;
            }

            .leaderboard-item {
                padding: 10px 12px;
                flex-direction: column;
                align-items: flex-start;
            }

            .rank {
                position: absolute;
                top: 10px;
                right: 12px;
                margin: 0;
            }

            .participant-info {
                width: 100%;
                padding-right: 40px;
            }

            .hafalan-count {
                margin-top: 10px;
                font-size: 0.9em;
            }

            .stats {
                font-size: 0.8em;
            }

            .modal-content {
                padding: 15px 10px;
                max-height: 90vh;
            }

            .attendance-table th,
            .attendance-table td {
                padding: 6px 4px;
                font-size: 12px;
            }

            .status-option {
                padding: 10px 8px;
            }

            .status-icon {
                font-size: 20px;
            }

            .level-stats {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            }
        }

        @media (max-width: 320px) {
            .header h1 {
                font-size: 1em;
            }

            .tab {
                padding: 10px 6px;
                font-size: 13px;
            }

            .content {
                padding: 10px 6px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container" x-data="tahfizhTracker()">
        <!-- Login Form untuk Admin -->
        <div x-show="!isLoggedIn && activeTab === 'admin'" class="login-form">
            <h2 style="color: #1a4d3a; text-align: center; margin-bottom: 20px;">üîê Login Admin</h2>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" x-model="loginUsername" placeholder="Masukkan username">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" x-model="loginPassword" placeholder="Masukkan password">
            </div>
            <button class="btn btn-primary" @click="adminLogin()">Login</button>
            <div x-show="loginError" class="alert alert-error" x-text="loginError"></div>
        </div>

        <!-- Main Content -->
        <div x-show="activeTab !== 'admin' || isLoggedIn">
            <div class="header">
                <h1>üïå Rekap Tahfizh Al-Quran</h1>
                <p>Barakallahu fiikum, semoga Allah mudahkan hafalan!</p>
                <p>üìö Sistem Manajemen Tahfizh Digital</p>
            </div>

            <div class="tabs">
                <div class="tab" :class="{ active: activeTab === 'ziyadah' }" @click="changeTab('ziyadah')">
                    üìù Input Setoran
                </div>
                <div class="tab" :class="{ active: activeTab === 'leaderboard' }" @click="changeTab('leaderboard')">
                    üìä Rekap Hafalan
                </div>
                <div class="tab" :class="{ active: activeTab === 'absensi', disabled: !isLoggedIn }" @click="changeTab('absensi')">
                    üìã Absensi
                </div>
                <div class="tab" :class="{ active: activeTab === 'admin', disabled: !isLoggedIn }" @click="changeTab('admin')">
                    ‚öôÔ∏è Admin 
                </div>
            </div>

            <div class="content">
                <!-- Tab Input Setoran -->
                <div x-show="activeTab === 'ziyadah'">
                    <h2 style="color: #1a4d3a; margin-bottom: 20px;">üìù Input Kehadiran & Setoran</h2>
                    
                    <div class="form-group">
                        <label for="musyrif">Pilih Musyrif:</label>
                        <select id="musyrif" x-model="selectedMusyrif" @change="resetParticipantSelection()" :class="{ 'error-border': validationErrors.musyrif }">
                            <option value="">-- Pilih Musyrif --</option>
                            <template x-for="musyrif in musyrifList" :key="musyrif.id">
                                <option :value="musyrif.id" x-text="musyrif.name"></option>
                            </template>
                        </select>
                    </div>

                    <div class="form-group" x-show="selectedMusyrif">
                        <label for="participant">Pilih Peserta:</label>
                        <select id="participant" x-model="selectedParticipant" :class="{ 'error-border': validationErrors.participant }">
                            <option value="">-- Pilih Peserta --</option>
                            <template x-for="participant in filteredParticipants" :key="participant.id">
                                <option :value="participant.id" x-text="participant.name + ' (' + getLevelName(participant.level) + ')'"></option>
                            </template>
                        </select>
                    </div>

                    <div class="form-group" x-show="selectedParticipant">
                        <label>Status Kehadiran:</label>
                        <div class="status-options">
                            <div class="status-option" :class="{ active: attendanceStatus === 'ziyadah' }" @click="attendanceStatus = 'ziyadah'">
                                <div class="status-icon">üìö</div>
                                <div><strong>Setoran</strong></div>
                                <div style="font-size: 12px; color: #666;">Ziyadah hafalan baru</div>
                            </div>
                            <div class="status-option" :class="{ active: attendanceStatus === 'ujian' }" @click="attendanceStatus = 'ujian'">
                                <div class="status-icon">üìù</div>
                                <div><strong>Ujian</strong></div>
                                <div style="font-size: 12px; color: #666;">Ujian juz/surah</div>
                            </div>
                            <div class="status-option" :class="{ active: attendanceStatus === 'sakit' }" @click="attendanceStatus = 'sakit'">
                                <div class="status-icon">ü§í</div>
                                <div><strong>Sakit</strong></div>
                                <div style="font-size: 12px; color: #666;">Tidak hadir karena sakit</div>
                            </div>
                            <div class="status-option" :class="{ active: attendanceStatus === 'berhalangan' }" @click="attendanceStatus = 'berhalangan'">
                                <div class="status-icon">üìÖ</div>
                                <div><strong>Berhalangan</strong></div>
                                <div style="font-size: 12px; color: #666;">Ada keperluan lain</div>
                            </div>
                        </div>
                    </div>

                    <div x-show="attendanceStatus === 'ziyadah'" class="ziyadah-fields">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fromPage">Dari Halaman:</label>
                                <input type="number" id="fromPage" x-model="ziyadahFromPage" min="1" placeholder="Halaman awal">
                            </div>
                            <div class="form-group">
                                <label for="toPage">Sampai Halaman:</label>
                                <input type="number" id="toPage" x-model="ziyadahToPage" min="1" placeholder="Halaman akhir">
                            </div>
                        </div>
                    </div>

                    <div x-show="attendanceStatus === 'ujian'" class="ujian-fields">
                        <div class="form-group">
                            <label for="juzUjian">Juz yang Diujikan:</label>
                            <select id="juzUjian" x-model="juzUjian">
                                <option value="">-- Pilih Juz --</option>
                                <template x-for="i in 30" :key="i">
                                    <option :value="i" x-text="'Juz ' + i"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="keteranganUjian">Keterangan (opsional):</label>
                            <textarea id="keteranganUjian" x-model="keteranganUjian" placeholder="Catatan tambahan ujian" rows="3"></textarea>
                        </div>
                    </div>

                    <button class="btn btn-primary" @click="submitAttendance()" x-show="selectedParticipant && attendanceStatus" :disabled="loading" :class="{ loading: loading }">
                        <span x-show="!loading">üíæ Simpan Data</span>
                        <span x-show="loading" class="spinner"></span>
                    </button>

                    <div x-show="Object.keys(validationErrors).length > 0" class="alert alert-error">
                        <template x-for="error in Object.values(validationErrors)" :key="error">
                            <div x-text="error"></div>
                        </template>
                    </div>

                    <div x-show="message" class="alert" :class="messageType === 'success' ? 'alert-success' : 'alert-error'" x-text="message"></div>
                </div>

                <!-- Tab Rekap Hafalan -->
                <div x-show="activeTab === 'leaderboard'">
                    <h2 style="color: #1a4d3a; margin-bottom: 20px;">üìä Rekap Hafalan</h2>
                    
                    <div class="filter-selector">
                        <div class="filter-row">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="color: #1a4d3a; font-weight: bold; margin-bottom: 10px; display: block;">Filter Musyrif:</label>
                                <select x-model="selectedMusyrifFilter">
                                    <option value="">Semua Musyrif</option>
                                    <template x-for="musyrif in musyrifList" :key="musyrif.id">
                                        <option :value="musyrif.id" x-text="musyrif.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label style="color: #1a4d3a; font-weight: bold; margin-bottom: 10px; display: block;">Filter Level:</label>
                                <select x-model="selectedLevelFilter">
                                    <option value="">Semua Level</option>
                                    <option value="1">Level 1 (Hal 1-101)</option>
                                    <option value="2">Level 2 (Hal 102-201)</option>
                                    <option value="3">Level 3 (Hal 202-301)</option>
                                    <option value="4">Level 4 (Hal 302-401)</option>
                                    <option value="5">Level 5 (Hal 402-501)</option>
                                    <option value="6">Level 6 (Hal 502-604)</option>
                                    <option value="7">Level 7 (Hal 1-604)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="leaderboard">
                        <div class="leaderboard-header">
                            <h2>üèÜ Rekap Hafalan Al-Quran</h2>
                            <p>Peserta diurutkan berdasarkan abjad</p>
                            <p x-show="selectedMusyrifFilter || selectedLevelFilter" style="font-size: 0.9em; margin-top: 5px;">
                                Filter aktif: 
                                <span x-show="selectedMusyrifFilter" x-text="getSelectedMusyrifName()"></span>
                                <span x-show="selectedMusyrifFilter && selectedLevelFilter"> | </span>
                                <span x-show="selectedLevelFilter" x-text="getLevelName(selectedLevelFilter)"></span>
                            </p> 
                        </div>
                        
                        <template x-for="(participant, index) in filteredParticipantsForLeaderboard" :key="participant.id">
                            <div class="leaderboard-item">
                                <div class="rank" x-text="index + 1"></div>
                                <div class="participant-info">
                                    <div class="participant-name" x-text="participant.name"></div>
                                    <div class="level-badge" :class="'level-' + participant.level" x-text="getLevelName(participant.level)"></div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" :style="`width: ${getParticipantProgress(participant)}%`"></div>
                                    </div>
                                    <div class="stats">
                                        <div>Setoran terakhir: <span x-text="participant.lastZiyadah"></span></div>
                                        <div x-show="participant.lastUjianDate">
                                            Ujian terakhir: <span x-text="formatDate(participant.lastUjianDate)"></span> (Juz <span x-text="participant.lastJuzUjian"></span>)
                                        </div>
                                        <div>Progress: <span x-text="Math.round(getParticipantProgress(participant))"></span>%</div>
                                    </div>
                                </div>
                                <div class="hafalan-count">
                                    <!-- Removed total hafalan display -->
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Tab Absensi -->
                <div x-show="activeTab === 'absensi'">
                    <div x-show="!isLoggedIn" class="alert alert-error">
                        üîí Fitur ini hanya tersedia untuk admin. Silakan login terlebih dahulu.
                    </div>
                    
                    <div x-show="isLoggedIn">
                        <h2 style="color: #1a4d3a; margin-bottom: 20px;">üìä Overview Absensi</h2>
                        
                        <div class="admin-actions" style="margin-bottom: 20px;">
                            <button class="btn btn-success" @click="exportToCSV()">
                                üì• Export CSV
                            </button>
                        </div>
                        
                        <div class="filter-selector">
                            <div class="filter-row">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="color: #1a4d3a; font-weight: bold; margin-bottom: 10px; display: block;">Filter Musyrif:</label>
                                    <select x-model="selectedAbsensiMusyrif">
                                        <option value="">Semua Musyrif</option>
                                        <template x-for="musyrif in musyrifList" :key="musyrif.id">
                                            <option :value="musyrif.id" x-text="musyrif.name"></option>
                                        </template>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="color: #1a4d3a; font-weight: bold; margin-bottom: 10px; display: block;">Filter Bulan:</label>
                                    <select x-model="selectedMonth">
                                        <template x-for="month in availableMonths" :key="month.value">
                                            <option :value="month.value" x-text="month.label"></option>
                                        </template>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="leaderboard">
                            <div class="leaderboard-header">
                                <h3>üìã Rekap Kehadiran & Setoran</h3>
                                <p x-text="'Bulan: ' + getSelectedMonthName()"></p>
                                <p x-show="selectedAbsensiMusyrif" x-text="'Musyrif: ' + getSelectedAbsensiMusyrifName()"></p>
                            </div>
                            
                            <template x-for="(participant, index) in getMonthlyOverview" :key="participant.id">
                                <div class="leaderboard-item">
                                    <div class="rank" x-text="index + 1"></div>
                                    <div class="participant-info">
                                        <div class="participant-name" x-text="participant.name"></div>
                                        <div class="level-badge" :class="'level-' + participant.level" x-text="getLevelName(participant.level)"></div>
                                        <div class="stats">
                                            <div>Kehadiran: <strong x-text="participant.kehadiran"></strong> hari</div>
                                            <div>Izin/Sakit: <strong x-text="participant.izinSakit"></strong> hari</div>
                                            <div>Setoran bulan ini: <strong x-text="participant.setoranBulanIni"></strong> halaman</div>
                                        </div>
                                    </div>
                                    <div class="hafalan-count">
                                        <span x-text="participant.setoranBulanIni"></span> hal
                                        <div style="font-size: 0.8em; color: #666;">
                                            setoran
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <h3 style="color: #1a4d3a; margin: 30px 0 20px 0;">üìã Detail Absensi</h3>
                        <div class="attendance-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Tanggal</th>
                                        <th>Peserta</th>
                                        <th>Level</th>
                                        <th>Status</th>
                                        <th>Detail</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="record in filteredAttendanceRecords" :key="record.id">
                                        <tr>
                                            <td x-text="formatDate(record.date)"></td>
                                            <td x-text="getParticipantName(record.participantId)"></td>
                                            <td>
                                                <span class="level-badge" :class="'level-' + getParticipantLevel(record.participantId)" x-text="getLevelName(getParticipantLevel(record.participantId))"></span>
                                            </td>
                                            <td>
                                                <span class="attendance-status" :class="'status-' + record.status" x-text="formatStatus(record.status)"></span>
                                            </td>
                                            <td>
                                                <span x-show="record.status === 'ziyadah'" x-text="'Hal ' + record.fromPage + '-' + record.toPage"></span>
                                                <span x-show="record.status === 'ujian'" x-text="'Juz ' + record.juzUjian"></span>
                                                <span x-show="record.status === 'sakit' || record.status === 'berhalangan'">-</span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab Admin -->
                <div x-show="activeTab === 'admin' && isLoggedIn">
                    <div class="current-user">
                        üîê Login sebagai: <strong>admin</strong> 
                        <button class="btn btn-secondary btn-small" @click="adminLogout()">Logout</button>
                    </div>

                    <h2 style="color: #1a4d3a; margin-bottom: 20px;">‚öôÔ∏è Admin Panel</h2>
                    
                    <div class="admin-actions">
                        <button class="btn btn-success" @click="showAddMusyrifModal = true">
                            ‚ûï Tambah Musyrif
                        </button>
                        <button class="btn btn-primary" @click="showAddParticipantModal = true">
                            ‚ûï Tambah Peserta
                        </button>
                        <button class="btn btn-primary" @click="showEditParticipantModal = true">
                            ‚úèÔ∏è Edit Peserta
                        </button>
                        <button class="btn btn-danger" @click="resetAllData()">
                            üóëÔ∏è Reset Data
                        </button>
                    </div>

                    <div class="admin-stats">
                        <h3 style="margin-bottom: 15px;">üìà Statistik</h3>
                        <p><strong>Total Musyrif:</strong> <span x-text="musyrifList.length"></span></p>
                        <p><strong>Total Peserta:</strong> <span x-text="participants.length"></span></p>
                        <p><strong>Peserta Ter-rajin:</strong> <span x-text="getMostDiligentParticipant()?.name || 'Belum ada'"></span></p>
                        
                        <div class="level-stats">
                            <template x-for="level in [1,2,3,4,5,6,7]" :key="level">
                                <div class="level-stat-card">
                                    <div class="level-stat-number" x-text="getLevelParticipantCount(level)"></div>
                                    <div class="level-stat-label" x-text="'Level ' + level"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Tambah Musyrif -->
        <div x-show="showAddMusyrifModal" class="modal" x-transition>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Tambah Musyrif Baru</h3>
                    <button class="close-btn" @click="showAddMusyrifModal = false">√ó</button>
                </div>
                <div class="form-group">
                    <label>Nama Musyrif:</label>
                    <input type="text" x-model="newMusyrifName" placeholder="Masukkan nama musyrif">
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" @click="addMusyrif()">Tambah</button>
                    <button class="btn btn-secondary" @click="showAddMusyrifModal = false">Batal</button>
                </div>
            </div>
        </div>

        <!-- Modal Tambah Peserta -->
        <div x-show="showAddParticipantModal" class="modal" x-transition>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Tambah Peserta Baru</h3>
                    <button class="close-btn" @click="showAddParticipantModal = false">√ó</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Pilih Musyrif:</label>
                        <select x-model="newParticipantMusyrifId">
                            <option value="">-- Pilih Musyrif --</option>
                            <template x-for="musyrif in musyrifList" :key="musyrif.id">
                                <option :value="musyrif.id" x-text="musyrif.name"></option>
                            </template>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Level Hafalan:</label>
                        <select x-model="newParticipantLevel">
                            <option value="">-- Pilih Level --</option>
                            <option value="1">Level 1 (Hal 1-101)</option>
                            <option value="2">Level 2 (Hal 102-201)</option>
                            <option value="3">Level 3 (Hal 202-301)</option>
                            <option value="4">Level 4 (Hal 302-401)</option>
                            <option value="5">Level 5 (Hal 402-501)</option>
                            <option value="6">Level 6 (Hal 502-604)</option>
                            <option value="7">Level 7 (Hal 1-604)</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Nama Peserta:</label>
                    <input type="text" x-model="newParticipantName" placeholder="Masukkan nama lengkap">
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" @click="addParticipant()">Tambah</button>
                    <button class="btn btn-secondary" @click="showAddParticipantModal = false">Batal</button>
                </div>
            </div>
        </div>

        <!-- Modal Edit Peserta -->
        <div x-show="showEditParticipantModal" class="modal" x-transition>
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Data Peserta</h3>
                    <button class="close-btn" @click="showEditParticipantModal = false">√ó</button>
                </div>
                <div class="form-group">
                    <label>Pilih Peserta:</label>
                    <select x-model="editingParticipant">
                        <option value="">-- Pilih Peserta --</option>
                        <template x-for="participant in sortedParticipantsByName" :key="participant.id">
                            <option :value="participant.id" x-text="participant.name + ' (' + getLevelName(participant.level) + ' - ' + getMusyrifName(participant.musyrifId) + ')'"></option>
                        </template>
                    </select>
                </div>
                <template x-if="editingParticipant">
                    <div>
                        <div class="form-group">
                            <label>Nama:</label>
                            <input type="text" x-model="editParticipantName">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Musyrif:</label>
                                <select x-model="editParticipantMusyrifId">
                                    <template x-for="musyrif in musyrifList" :key="musyrif.id">
                                        <option :value="musyrif.id" x-text="musyrif.name"></option>
                                    </template>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Level:</label>
                                <select x-model="editParticipantLevel">
                                    <option value="1">Level 1 (Hal 1-101)</option>
                                    <option value="2">Level 2 (Hal 102-201)</option>
                                    <option value="3">Level 3 (Hal 202-301)</option>
                                    <option value="4">Level 4 (Hal 302-401)</option>
                                    <option value="5">Level 5 (Hal 402-501)</option>
                                    <option value="6">Level 6 (Hal 502-604)</option>
                                    <option value="7">Level 7 (Hal 1-604)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Total Hafalan (Halaman):</label>
                            <input type="number" x-model="editParticipantHafalan" min="0">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-success" @click="saveParticipantEdit()">Simpan</button>
                            <button class="btn btn-danger" @click="deleteParticipant()">Hapus</button>
                            <button class="btn btn-secondary" @click="showEditParticipantModal = false">Batal</button>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function tahfizhTracker() {
            return {
                activeTab: 'ziyadah',
                isLoggedIn: false,
                loginUsername: '',
                loginPassword: '',
                loginError: '',
                
                // Data Musyrif
                musyrifList: [
                    { id: 1, name: 'Ustadz Ahmad Fauzi' },
                    { id: 2, name: 'Ustadz Muhammad Rizki' },
                    { id: 3, name: 'Ustadzah Fatimah Zahra' }
                ],
                
                // Data Peserta dengan level dan range halaman yang benar
                participants: [
                    { id: 1, name: 'Ahmad Zaki', musyrifId: 1, level: 1, totalHalaman: 85, lastZiyadah: 'Hal 80-85', lastJuzUjian: 2, lastUjianDate: '2025-01-10' },
                    { id: 2, name: 'Fatimah Aulia', musyrifId: 1, level: 2, totalHalaman: 154, lastZiyadah: 'Hal 149-154', lastJuzUjian: 6, lastUjianDate: '2025-01-08' },
                    { id: 3, name: 'Muhammad Hafiz', musyrifId: 2, level: 7, totalHalaman: 580, lastZiyadah: 'Hal 575-580', lastJuzUjian: 29, lastUjianDate: '2025-01-05' },
                    { id: 4, name: 'Aisyah Rahmah', musyrifId: 2, level: 3, totalHalaman: 275, lastZiyadah: 'Hal 270-275', lastJuzUjian: 11, lastUjianDate: '2025-01-12' },
                    { id: 5, name: 'Yusuf Ibrahim', musyrifId: 3, level: 4, totalHalaman: 360, lastZiyadah: 'Hal 355-360', lastJuzUjian: 16, lastUjianDate: '2025-01-06' },
                    { id: 6, name: 'Khadijah Nur', musyrifId: 3, level: 5, totalHalaman: 470, lastZiyadah: 'Hal 465-470', lastJuzUjian: 21, lastUjianDate: '2025-01-09' }
                ],
                
                // Form data
                selectedMusyrif: '',
                selectedParticipant: '',
                attendanceStatus: '',
                ziyadahFromPage: '',
                ziyadahToPage: '',
                juzUjian: '',
                keteranganUjian: '',
                message: '',
                messageType: 'success',
                
                // Filters
                selectedMusyrifFilter: '',
                selectedLevelFilter: '',
                selectedAbsensiMusyrif: '',
                selectedMonth: '',
                
                // UI state
                loading: false,
                validationErrors: {},
                
                // Modal states
                showAddMusyrifModal: false,
                showAddParticipantModal: false,
                showEditParticipantModal: false,
                
                // Form data for modals
                newMusyrifName: '',
                newParticipantName: '',
                newParticipantMusyrifId: '',
                newParticipantLevel: '',
                editingParticipant: '',
                editParticipantName: '',
                editParticipantMusyrifId: '',
                editParticipantLevel: '',
                editParticipantHafalan: '',
                
                // Records
                attendanceRecords: [
                    { id: 1, participantId: 1, status: 'ziyadah', date: '2025-01-10', fromPage: 80, toPage: 85 },
                    { id: 2, participantId: 2, status: 'ujian', date: '2025-01-08', juzUjian: 6 },
                    { id: 3, participantId: 3, status: 'sakit', date: '2025-01-09' },
                    { id: 4, participantId: 4, status: 'ziyadah', date: '2025-01-11', fromPage: 270, toPage: 275 },
                    { id: 5, participantId: 5, status: 'berhalangan', date: '2025-01-07' },
                    { id: 6, participantId: 1, status: 'ziyadah', date: '2025-01-05', fromPage: 70, toPage: 79 },
                    { id: 7, participantId: 2, status: 'ziyadah', date: '2025-01-03', fromPage: 144, toPage: 148 },
                    { id: 8, participantId: 3, status: 'ziyadah', date: '2025-01-02', fromPage: 570, toPage: 574 },
                    { id: 9, participantId: 4, status: 'ziyadah', date: '2025-01-01', fromPage: 260, toPage: 269 },
                    { id: 10, participantId: 5, status: 'ziyadah', date: '2025-01-04', fromPage: 350, toPage: 359 },
                    { id: 11, participantId: 6, status: 'ziyadah', date: '2024-12-15', fromPage: 455, toPage: 464 },
                    { id: 12, participantId: 1, status: 'ujian', date: '2024-12-20', juzUjian: 2 },
                    { id: 13, participantId: 2, status: 'ziyadah', date: '2024-12-18', fromPage: 134, toPage: 143 }
                ],

                init() {
                    this.loadData();
                    this.selectedMonth = this.getCurrentMonth();
                },

                // Level System dengan range halaman yang benar
                getLevelName(level) {
                    const levels = {
                        1: 'Level 1 (Hal 1-101)',
                        2: 'Level 2 (Hal 102-201)', 
                        3: 'Level 3 (Hal 202-301)',
                        4: 'Level 4 (Hal 302-401)',
                        5: 'Level 5 (Hal 402-501)',
                        6: 'Level 6 (Hal 502-604)',
                        7: 'Level 7 (Hal 1-604)'
                    };
                    return levels[level] || 'Unknown';
                },

                getLevelRange(level) {
                    const ranges = {
                        1: '1-101',
                        2: '102-201',
                        3: '202-301',
                        4: '302-401',
                        5: '402-501',
                        6: '502-604',
                        7: '1-604'
                    };
                    return 'Hal ' + (ranges[level] || '');
                },

                getLevelStartPage(level) {
                    const startPages = {
                        1: 1,
                        2: 102,
                        3: 202,
                        4: 302,
                        5: 402,
                        6: 502,
                        7: 1
                    };
                    return startPages[level] || 1;
                },

                getMaxPagesForLevel(level) {
                    const maxPages = {
                        1: 101,
                        2: 201,
                        3: 301,
                        4: 401,
                        5: 501,
                        6: 604,
                        7: 604
                    };
                    return maxPages[level] || 101;
                },

                getParticipantProgress(participant) {
                    const startPage = this.getLevelStartPage(participant.level);
                    const maxPage = this.getMaxPagesForLevel(participant.level);
                    const currentPage = participant.totalHalaman;
                    
                    if (participant.level === 7) {
                        // Level 7 progress dari 1-604 (604 halaman total)
                        return Math.min((currentPage / 604) * 100, 100);
                    } else {
                        // Level lain progress berdasarkan range 100 halaman
                        // Misal Level 3: startPage=202, currentPage=250
                        // Progress = (250-202+1) / 100 * 100 = 49%
                        const completedPages = Math.max(0, currentPage - startPage + 1);
                        const levelRange = 100; // Setiap level target 100 halaman
                        return Math.min((completedPages / levelRange) * 100, 100);
                    }
                },

                // Method untuk menghitung peserta per level
                getLevelParticipantCount(level) {
                    return this.participants.filter(p => p.level === level).length;
                },

                // Method untuk menentukan peserta ter-rajin
                getMostDiligentParticipant() {
                    if (this.participants.length === 0) return null;
                    
                    const participantScores = this.participants.map(participant => {
                        const participantRecords = this.attendanceRecords.filter(r => r.participantId === participant.id);
                        
                        // Hitung kehadiran (ziyadah + ujian)
                        const attendanceCount = participantRecords.filter(r => r.status === 'ziyadah' || r.status === 'ujian').length;
                        
                        // Hitung total ziyadah pages
                        const ziyadahRecords = participantRecords.filter(r => r.status === 'ziyadah');
                        const totalZiyadahPages = ziyadahRecords.reduce((sum, record) => {
                            return sum + (record.toPage - record.fromPage + 1);
                        }, 0);
                        
                        // Score: kombinasi attendance dan ziyadah pages
                        const score = (attendanceCount * 10) + (totalZiyadahPages * 0.5);
                        
                        return {
                            participant,
                            score,
                            attendanceCount,
                            totalZiyadahPages
                        };
                    });
                    
                    // Sort by score descending dan ambil yang tertinggi
                    participantScores.sort((a, b) => b.score - a.score);
                    return participantScores[0]?.participant;
                },

                // Month Management
                getCurrentMonth() {
                    const date = new Date();
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                },

                get availableMonths() {
                    const months = new Set();
                    const currentDate = new Date();
                    
                    // Add current month
                    months.add(this.getCurrentMonth());
                    
                    // Add months from attendance records
                    this.attendanceRecords.forEach(record => {
                        const date = new Date(record.date);
                        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        months.add(monthKey);
                    });
                    
                    return Array.from(months).sort((a, b) => b.localeCompare(a)).map(monthKey => {
                        const [year, month] = monthKey.split('-');
                        const date = new Date(year, month - 1);
                        return {
                            value: monthKey,
                            label: date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })
                        };
                    });
                },

                getSelectedMonthName() {
                    const selected = this.availableMonths.find(m => m.value === this.selectedMonth);
                    return selected ? selected.label : 'Bulan ini';
                },

                // Computed properties
                get filteredParticipants() {
                    if (!this.selectedMusyrif) return [];
                    return this.participants.filter(p => p.musyrifId == this.selectedMusyrif);
                },

                get filteredParticipantsForLeaderboard() {
                    let filtered = this.participants;
                    
                    if (this.selectedMusyrifFilter) {
                        filtered = filtered.filter(p => p.musyrifId == this.selectedMusyrifFilter);
                    }
                    
                    if (this.selectedLevelFilter) {
                        filtered = filtered.filter(p => p.level == this.selectedLevelFilter);
                    }
                    
                    return filtered.sort((a, b) => a.name.localeCompare(b.name));
                },

                get sortedParticipants() {
                    return [...this.participants].sort((a, b) => b.totalHalaman - a.totalHalaman);
                },

                get sortedParticipantsByName() {
                    return [...this.participants].sort((a, b) => a.name.localeCompare(b.name));
                },

                get filteredAttendanceRecords() {
                    let filtered = this.attendanceRecords;
                    
                    // Filter by selected month
                    if (this.selectedMonth) {
                        const [year, month] = this.selectedMonth.split('-');
                        filtered = filtered.filter(r => {
                            const date = new Date(r.date);
                            return date.getFullYear() == year && (date.getMonth() + 1) == month;
                        });
                    }
                    
                    // Filter by musyrif
                    if (this.selectedAbsensiMusyrif) {
                        const participantIds = this.participants
                            .filter(p => p.musyrifId == this.selectedAbsensiMusyrif)
                            .map(p => p.id);
                        filtered = filtered.filter(r => participantIds.includes(r.participantId));
                    }
                    
                    return filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
                },

                get getMonthlyOverview() {
                    if (!this.selectedMonth) return [];
                    
                    const [year, month] = this.selectedMonth.split('-');
                    
                    let filteredParticipants = this.selectedAbsensiMusyrif ? 
                        this.participants.filter(p => p.musyrifId == this.selectedAbsensiMusyrif) : 
                        this.participants;
                    
                    return filteredParticipants.map(participant => {
                        const participantRecords = this.attendanceRecords.filter(r => {
                            const date = new Date(r.date);
                            return r.participantId === participant.id && 
                                   date.getFullYear() == year && 
                                   (date.getMonth() + 1) == month;
                        });
                        
                        const kehadiran = participantRecords.filter(r => r.status === 'ziyadah' || r.status === 'ujian').length;
                        const izinSakit = participantRecords.filter(r => r.status === 'sakit' || r.status === 'berhalangan').length;
                        
                        // Hitung setoran bulan ini
                        const ziyadahRecords = participantRecords.filter(r => r.status === 'ziyadah').sort((a, b) => new Date(a.date) - new Date(b.date));
                        let setoranBulanIni = 0;
                        
                        if (ziyadahRecords.length > 0) {
                            setoranBulanIni = ziyadahRecords.reduce((sum, record) => {
                                return sum + (record.toPage - record.fromPage + 1);
                            }, 0);
                        }
                        
                        return {
                            id: participant.id,
                            name: participant.name,
                            level: participant.level,
                            kehadiran,
                            izinSakit,
                            setoranBulanIni
                        };
                    }).sort((a, b) => a.name.localeCompare(b.name));
                },

                // Helper methods
                getSelectedAbsensiMusyrifName() {
                    const musyrif = this.musyrifList.find(m => m.id == this.selectedAbsensiMusyrif);
                    return musyrif ? musyrif.name : '';
                },

                // Methods
                changeTab(tab) {
                    try {
                        if (tab === 'admin' && !this.isLoggedIn) {
                            this.activeTab = 'admin';
                            return;
                        }
                        if (tab === 'absensi' && !this.isLoggedIn) {
                            this.showMessage('Akses ditolak. Silakan login sebagai admin terlebih dahulu.', 'error');
                            return;
                        }
                        this.activeTab = tab;
                    } catch (error) {
                        this.handleError('Gagal mengubah tab', error);
                    }
                },

                validateForm(type) {
                    this.validationErrors = {};
                    let isValid = true;

                    if (!this.selectedParticipant) {
                        this.validationErrors.participant = 'Peserta harus dipilih';
                        isValid = false;
                    }

                    if (!this.attendanceStatus) {
                        this.validationErrors.status = 'Status kehadiran harus dipilih';
                        isValid = false;
                    }

                    if (this.attendanceStatus === 'ziyadah') {
                        if (!this.ziyadahFromPage || !this.ziyadahToPage) {
                            this.validationErrors.ziyadah = 'Rentang halaman harus diisi';
                            isValid = false;
                        } else {
                            const from = parseInt(this.ziyadahFromPage);
                            const to = parseInt(this.ziyadahToPage);
                            if (from < 1 || from > to || isNaN(from) || isNaN(to)) {
                                this.validationErrors.ziyadah = 'Rentang halaman tidak valid';
                                isValid = false;
                            }
                        }
                    }

                    if (this.attendanceStatus === 'ujian' && !this.juzUjian) {
                        this.validationErrors.ujian = 'Juz yang diujikan harus dipilih';
                        isValid = false;
                    }

                    return isValid;
                },

                handleError(message, error = null) {
                    console.error(message, error);
                    this.showMessage(message + (error ? ': ' + error.message : ''), 'error');
                    this.loading = false;
                },

                exportToCSV() {
                    try {
                        this.loading = true;
                        
                        const monthName = this.getSelectedMonthName();
                        
                        // Header CSV
                        let csvContent = "data:text/csv;charset=utf-8,";
                        csvContent += `Rekap Absensi Tahfizh - ${monthName}\n`;
                        csvContent += `Exported: ${new Date().toLocaleDateString('id-ID')}\n\n`;
                        
                        // Overview Data
                        csvContent += "OVERVIEW PESERTA\n";
                        csvContent += "No,Nama,Level,Musyrif,Kehadiran,Izin/Sakit,Setoran (hal)\n";
                        
                        const overview = this.getMonthlyOverview;
                        overview.forEach((participant, index) => {
                            const fullParticipant = this.participants.find(p => p.id === participant.id);
                            const musyrifName = this.getMusyrifName(fullParticipant?.musyrifId);
                            const levelName = this.getLevelName(participant.level);
                            csvContent += `${index + 1},"${participant.name}","${levelName}","${musyrifName}",${participant.kehadiran},${participant.izinSakit},${participant.setoranBulanIni}\n`;
                        });
                        
                        // Detail Records
                        csvContent += "\nDETAIL ABSENSI\n";
                        csvContent += "Tanggal,Nama,Level,Musyrif,Status,Detail\n";
                        
                        const records = this.filteredAttendanceRecords;
                        records.forEach(record => {
                            const participant = this.participants.find(p => p.id === record.participantId);
                            const musyrifName = this.getMusyrifName(participant?.musyrifId);
                            const levelName = this.getLevelName(participant?.level);
                            let detail = '';
                            
                            if (record.status === 'ziyadah') {
                                detail = `Hal ${record.fromPage}-${record.toPage}`;
                            } else if (record.status === 'ujian') {
                                detail = `Juz ${record.juzUjian}`;
                            } else {
                                detail = '-';
                            }
                            
                            csvContent += `${this.formatDate(record.date)},"${participant?.name || 'Unknown'}","${levelName}","${musyrifName}","${this.formatStatus(record.status)}","${detail}"\n`;
                        });
                        
                        // Download
                        const encodedUri = encodeURI(csvContent);
                        const link = document.createElement("a");
                        link.setAttribute("href", encodedUri);
                        link.setAttribute("download", `tahfizh_${monthName.replace(/\s+/g, '_')}.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        this.showMessage('Data berhasil diexport ke CSV', 'success');
                        
                    } catch (error) {
                        this.handleError('Gagal export CSV', error);
                    } finally {
                        this.loading = false;
                    }
                },

                resetParticipantSelection() {
                    this.selectedParticipant = '';
                    this.attendanceStatus = '';
                    this.validationErrors = {};
                    this.resetForm();
                },

                resetForm() {
                    this.ziyadahFromPage = '';
                    this.ziyadahToPage = '';
                    this.juzUjian = '';
                    this.keteranganUjian = '';
                },

                getMusyrifName(musyrifId) {
                    const musyrif = this.musyrifList.find(m => m.id === musyrifId);
                    return musyrif ? musyrif.name : 'Unknown';
                },

                getSelectedMusyrifName() {
                    const musyrif = this.musyrifList.find(m => m.id == this.selectedMusyrifFilter);
                    return musyrif ? musyrif.name : '';
                },

                getParticipantName(participantId) {
                    const participant = this.participants.find(p => p.id === participantId);
                    return participant ? participant.name : 'Unknown';
                },

                getParticipantLevel(participantId) {
                    const participant = this.participants.find(p => p.id === participantId);
                    return participant ? participant.level : 1;
                },

                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('id-ID', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                },

                formatStatus(status) {
                    const statusMap = {
                        ziyadah: 'Setoran',
                        ujian: 'Ujian',
                        sakit: 'Sakit',
                        berhalangan: 'Berhalangan'
                    };
                    return statusMap[status] || status;
                },

                adminLogin() {
                    if (this.loginUsername === 'admin' && this.loginPassword === 'tahfizh2025') {
                        this.isLoggedIn = true;
                        this.loginError = '';
                        this.loginUsername = '';
                        this.loginPassword = '';
                        this.showMessage('Login berhasil!', 'success');
                    } else {
                        this.loginError = 'Username atau password salah!';
                    }
                },

                adminLogout() {
                    this.isLoggedIn = false;
                    this.activeTab = 'ziyadah';
                    this.showMessage('Logout berhasil!', 'success');
                },

                submitAttendance() {
                    try {
                        this.loading = true;
                        
                        if (!this.validateForm()) {
                            this.loading = false;
                            return;
                        }

                        const participant = this.participants.find(p => p.id == this.selectedParticipant);
                        if (!participant) {
                            throw new Error('Peserta tidak ditemukan');
                        }

                        const record = {
                            id: Date.now(),
                            participantId: participant.id,
                            status: this.attendanceStatus,
                            date: new Date().toISOString().split('T')[0],
                            timestamp: new Date().toISOString()
                        };

                        if (this.attendanceStatus === 'ziyadah') {
                            const from = parseInt(this.ziyadahFromPage);
                            const to = parseInt(this.ziyadahToPage);

                            participant.totalHalaman = Math.max(participant.totalHalaman, to);
                            participant.lastZiyadah = `Hal ${from}-${to}`;
                            record.fromPage = from;
                            record.toPage = to;
                        }

                        if (this.attendanceStatus === 'ujian') {
                            participant.lastJuzUjian = parseInt(this.juzUjian);
                            participant.lastUjianDate = record.date;
                            record.juzUjian = this.juzUjian;
                            record.keteranganUjian = this.keteranganUjian;
                        }

                        this.attendanceRecords.push(record);
                        
                        // Auto-add new month if needed
                        const recordMonth = this.getMonthFromDate(record.date);
                        if (!this.availableMonths.find(m => m.value === recordMonth)) {
                            // Month will be auto-added via computed property
                        }
                        
                        this.saveData();
                        
                        this.showMessage(`Status ${this.formatStatus(this.attendanceStatus)} berhasil disimpan untuk ${participant.name}`, 'success');
                        this.resetAttendanceForm();
                        
                    } catch (error) {
                        this.handleError('Gagal menyimpan data kehadiran', error);
                    } finally {
                        this.loading = false;
                    }
                },

                getMonthFromDate(dateString) {
                    const date = new Date(dateString);
                    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                },

                resetAttendanceForm() {
                    this.selectedMusyrif = '';
                    this.selectedParticipant = '';
                    this.attendanceStatus = '';
                    this.validationErrors = {};
                    this.resetForm();
                },

                // Admin methods
                addMusyrif() {
                    try {
                        this.loading = true;
                        
                        if (!this.newMusyrifName.trim()) {
                            throw new Error('Nama musyrif tidak boleh kosong');
                        }

                        // Check duplicate
                        if (this.musyrifList.some(m => m.name.toLowerCase() === this.newMusyrifName.trim().toLowerCase())) {
                            throw new Error('Nama musyrif sudah ada');
                        }

                        const newId = Math.max(...this.musyrifList.map(m => m.id), 0) + 1;
                        this.musyrifList.push({
                            id: newId,
                            name: this.newMusyrifName.trim()
                        });

                        this.saveData();
                        this.showMessage(`Musyrif ${this.newMusyrifName} berhasil ditambahkan`, 'success');
                        this.newMusyrifName = '';
                        this.showAddMusyrifModal = false;
                        
                    } catch (error) {
                        this.handleError('Gagal menambah musyrif', error);
                    } finally {
                        this.loading = false;
                    }
                },

                addParticipant() {
                    try {
                        this.loading = true;
                        
                        if (!this.newParticipantName.trim() || !this.newParticipantMusyrifId || !this.newParticipantLevel) {
                            throw new Error('Nama peserta, musyrif, dan level harus diisi');
                        }

                        // Check duplicate
                        if (this.participants.some(p => p.name.toLowerCase() === this.newParticipantName.trim().toLowerCase())) {
                            throw new Error('Nama peserta sudah ada');
                        }

                        const newId = Math.max(...this.participants.map(p => p.id), 0) + 1;
                        const level = parseInt(this.newParticipantLevel);
                        const startPage = this.getLevelStartPage(level);
                        
                        this.participants.push({
                            id: newId,
                            name: this.newParticipantName.trim(),
                            musyrifId: parseInt(this.newParticipantMusyrifId),
                            level: level,
                            totalHalaman: startPage - 1, // Mulai dari sebelum start page
                            lastZiyadah: `Hal ${startPage - 1}-${startPage - 1}`,
                            lastJuzUjian: null,
                            lastUjianDate: null
                        });

                        this.saveData();
                        this.showMessage(`Peserta ${this.newParticipantName} berhasil ditambahkan`, 'success');
                        this.newParticipantName = '';
                        this.newParticipantMusyrifId = '';
                        this.newParticipantLevel = '';
                        this.showAddParticipantModal = false;
                        
                    } catch (error) {
                        this.handleError('Gagal menambah peserta', error);
                    } finally {
                        this.loading = false;
                    }
                },

                saveParticipantEdit() {
                    try {
                        this.loading = true;
                        
                        const participant = this.participants.find(p => p.id == this.editingParticipant);
                        if (!participant) {
                            throw new Error('Peserta tidak ditemukan');
                        }
                        
                        participant.name = this.editParticipantName;
                        participant.musyrifId = parseInt(this.editParticipantMusyrifId);
                        participant.level = parseInt(this.editParticipantLevel);
                        participant.totalHalaman = parseInt(this.editParticipantHafalan);
                        
                        this.saveData();
                        this.showMessage('Data peserta berhasil diperbarui', 'success');
                        this.showEditParticipantModal = false;
                        this.editingParticipant = '';
                        
                    } catch (error) {
                        this.handleError('Gagal mengubah data peserta', error);
                    } finally {
                        this.loading = false;
                    }
                },

                deleteParticipant() {
                    if (confirm('Apakah Anda yakin ingin menghapus peserta ini? Semua data absensi peserta juga akan terhapus.')) {
                        try {
                            this.participants = this.participants.filter(p => p.id != this.editingParticipant);
                            this.attendanceRecords = this.attendanceRecords.filter(r => r.participantId != this.editingParticipant);
                            this.saveData();
                            this.showMessage('Peserta berhasil dihapus', 'success');
                            this.showEditParticipantModal = false;
                            this.editingParticipant = '';
                        } catch (error) {
                            this.handleError('Gagal menghapus peserta', error);
                        }
                    }
                },

                resetAllData() {
                    if (confirm('Apakah Anda yakin ingin mereset semua data? Tindakan ini tidak dapat dibatalkan.')) {
                        try {
                            this.participants = [];
                            this.attendanceRecords = [];
                            this.musyrifList = [];
                            this.saveData();
                            this.showMessage('Semua data berhasil direset', 'success');
                        } catch (error) {
                            this.handleError('Gagal mereset data', error);
                        }
                    }
                },

                showMessage(msg, type) {
                    this.message = msg;
                    this.messageType = type;
                    setTimeout(() => {
                        this.message = '';
                    }, 5000);
                },

                saveData() {
                    // In a real app, this would save to backend/database
                    console.log('Data saved:', { 
                        participants: this.participants, 
                        attendanceRecords: this.attendanceRecords,
                        musyrifList: this.musyrifList
                    });
                },

                loadData() {
                    // In a real app, this would load from backend/database
                    console.log('Data loaded');
                },

                // Watch untuk auto-fill form edit
                $watch: {
                    editingParticipant(newVal) {
                        if (newVal) {
                            const participant = this.participants.find(p => p.id == newVal);
                            if (participant) {
                                this.editParticipantName = participant.name;
                                this.editParticipantMusyrifId = participant.musyrifId;
                                this.editParticipantLevel = participant.level;
                                this.editParticipantHafalan = participant.totalHalaman;
                            }
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>

